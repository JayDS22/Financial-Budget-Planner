// VisionFi Frontend â€” app.js
const API='';
let state={page:'landing',authMode:'register',tab:'dashboard',currentUser:null,users:[],dashData:null,chatOpen:false,chatSending:false,chatMessages:[{role:'ai',text:"Hi! I'm VisionFi AI ğŸ¤– powered by Claude. Ask about budget, credit, loans, or investments!"}],chatHistory:[],showApiSetup:false,investSub:'stocks',predPeriod:'daily',showAddTx:false,creditSub:'overview'};
let apiKey=localStorage.getItem('visionfi_api_key')||'';
const fmt=v=>{const n=Math.abs(v);return(v<0?'-':'')+'$'+n.toFixed(n%1===0?0:2).replace(/\B(?=(\d{3})+(?!\d))/g,',')};
async function api(m,p,b){const o={method:m,headers:{'Content-Type':'application/json'}};if(b)o.body=JSON.stringify(b);const r=await fetch(API+p,o);const d=await r.json();if(!r.ok)throw new Error(d.error||'Failed');return d}
async function loadDashboard(uid){state.loading=true;render();try{state.dashData=await api('GET','/api/dashboard/'+uid);state.currentUser=state.dashData.user}catch(e){state.error=e.message}state.loading=false;render()}
async function loadUsers(){try{state.users=await api('GET','/api/users')}catch(e){}}
function showToast(m,t){const e=document.createElement('div');e.className='toast toast-'+t;e.textContent=m;document.body.appendChild(e);setTimeout(()=>e.remove(),3000)}
function set(u){Object.assign(state,u);render()}
function scoreColor(s){return s>=750?'var(--green)':s>=700?'var(--blue)':s>=650?'var(--amber)':'var(--red)'}

// Charts
function drawChart(canvas,data,opts){if(!canvas)return;opts=opts||{};var ctx=canvas.getContext('2d'),dpr=window.devicePixelRatio||1,rect=canvas.getBoundingClientRect();canvas.width=rect.width*dpr;canvas.height=rect.height*dpr;ctx.scale(dpr,dpr);var W=rect.width,H=rect.height,pad={t:20,r:16,b:32,l:50},cW=W-pad.l-pad.r,cH=H-pad.t-pad.b;ctx.clearRect(0,0,W,H);var series=opts.series||[],allVals=[];series.forEach(function(s){data.forEach(function(d){allVals.push(d[s.key]||0)})});if(!allVals.length)return;var minV=Math.min.apply(null,allVals)*.85,maxV=Math.max.apply(null,allVals)*1.1,range=maxV-minV||1,xStep=cW/((data.length-1)||1);function getX(i){return pad.l+i*xStep}function getY(v){return pad.t+cH-(((v-minV)/range)*cH)}ctx.strokeStyle='rgba(255,255,255,.04)';ctx.lineWidth=1;for(var i=0;i<5;i++){var y=pad.t+(cH/4)*i;ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke()}ctx.fillStyle='#5a5a7a';ctx.font='10px IBM Plex Mono,monospace';ctx.textAlign='right';for(var i=0;i<5;i++){var v=maxV-((maxV-minV)/4)*i;ctx.fillText(opts.fmtY?opts.fmtY(v):'$'+Math.round(v),pad.l-8,pad.t+(cH/4)*i+3)}ctx.textAlign='center';data.forEach(function(d,i){if(data.length>15&&i%3!==0)return;ctx.fillText(d.label||'',getX(i),H-8)});series.forEach(function(s){var pts=data.map(function(d,i){return{x:getX(i),y:getY(d[s.key]||0)}});if(s.type==='bar'){var bW=Math.max(cW/data.length*.55,4),bs=series.filter(function(ss){return ss.type==='bar'}),idx=bs.indexOf(s),cnt=bs.length,off=(idx-cnt/2+.5)*bW*1.15;ctx.globalAlpha=s.opacity||1;pts.forEach(function(p){ctx.fillStyle=s.color;var bx=p.x+off-bW/2,by=p.y;ctx.beginPath();ctx.moveTo(bx+5,by);ctx.lineTo(bx+bW-5,by);ctx.quadraticCurveTo(bx+bW,by,bx+bW,by+5);ctx.lineTo(bx+bW,pad.t+cH);ctx.lineTo(bx,pad.t+cH);ctx.lineTo(bx,by+5);ctx.quadraticCurveTo(bx,by,bx+5,by);ctx.fill()});ctx.globalAlpha=1}else{ctx.beginPath();pts.forEach(function(p,i){if(i===0)ctx.moveTo(p.x,p.y);else{var prev=pts[i-1],cpx=(prev.x+p.x)/2;ctx.bezierCurveTo(cpx,prev.y,cpx,p.y,p.x,p.y)}});if(s.fill){ctx.lineTo(pts[pts.length-1].x,pad.t+cH);ctx.lineTo(pts[0].x,pad.t+cH);ctx.closePath();var grad=ctx.createLinearGradient(0,pad.t,0,pad.t+cH);grad.addColorStop(0,s.color+'33');grad.addColorStop(1,s.color+'00');ctx.fillStyle=grad;ctx.fill()}ctx.beginPath();pts.forEach(function(p,i){if(i===0)ctx.moveTo(p.x,p.y);else{var prev=pts[i-1],cpx=(prev.x+p.x)/2;ctx.bezierCurveTo(cpx,prev.y,cpx,p.y,p.x,p.y)}});ctx.strokeStyle=s.color;ctx.lineWidth=s.width||2;if(s.dash)ctx.setLineDash(s.dash);else ctx.setLineDash([]);ctx.stroke();ctx.setLineDash([])}});}
function sparkSVG(c){var pts=[];for(var i=0;i<12;i++)pts.push(Math.random());var w=80,h=28,mn=Math.min.apply(null,pts),mx=Math.max.apply(null,pts),r=mx-mn||1,p='M';pts.forEach(function(v,i){var x=(i/11)*w,y=h-((v-mn)/r)*h;p+=(i?'L':'')+x.toFixed(1)+' '+y.toFixed(1)});return'<svg width="'+w+'" height="'+h+'" viewBox="0 0 '+w+' '+h+'"><defs><linearGradient id="sp'+c.slice(1)+'" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="'+c+'" stop-opacity=".25"/><stop offset="100%" stop-color="'+c+'" stop-opacity="0"/></linearGradient></defs><path d="'+p+' L'+w+' '+h+' L0 '+h+' Z" fill="url(#sp'+c.slice(1)+')"/><path d="'+p+'" fill="none" stroke="'+c+'" stroke-width="1.5"/></svg>'}
function genMonthly(){return['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'].map(function(m){return{label:m,income:7500+Math.random()*2000,spending:4000+Math.random()*2500}})}
function genDaily(){return Array.from({length:30},function(_,i){return{label:''+(i+1),actual:Math.round(80+Math.random()*180),predicted:Math.round(120+Math.random()*60),budget:160}})}
function genWeekly(){return['Wk1','Wk2','Wk3','Wk4'].map(function(w){return{label:w,actual:Math.round(800+Math.random()*600),predicted:Math.round(900+Math.random()*400),budget:1100}})}
function scoreSVG(score){var pct=Math.min((score-300)/550,1),ang=pct*240-120,r=54;var sx=65+r*Math.cos(-120*Math.PI/180),sy=70+r*Math.sin(-120*Math.PI/180);var ex=65+r*Math.cos(ang*Math.PI/180),ey=70+r*Math.sin(ang*Math.PI/180);var large=pct>.5?1:0;var col=scoreColor(score);return'<svg class="score-ring" width="130" height="110" viewBox="0 0 130 110"><path d="M'+sx+' '+sy+' A'+r+' '+r+' 0 1 1 '+(65+r*Math.cos(120*Math.PI/180))+' '+(70+r*Math.sin(120*Math.PI/180))+'" fill="none" stroke="rgba(255,255,255,.06)" stroke-width="10" stroke-linecap="round"/><path d="M'+sx+' '+sy+' A'+r+' '+r+' 0 '+large+' 1 '+ex.toFixed(1)+' '+ey.toFixed(1)+'" fill="none" stroke="'+col+'" stroke-width="10" stroke-linecap="round"/><text x="65" y="68" text-anchor="middle" fill="'+col+'" font-size="28" font-weight="700" font-family="IBM Plex Mono,monospace">'+score+'</text><text x="65" y="86" text-anchor="middle" fill="#5a5a7a" font-size="10">CREDIT SCORE</text></svg>'}

// Static data
const STOCKS=[{sym:'AAPL',name:'Apple',price:245.82,chg:2.34,pct:0.96},{sym:'GOOGL',name:'Alphabet',price:189.45,chg:-1.23,pct:-0.65},{sym:'MSFT',name:'Microsoft',price:452.30,chg:5.67,pct:1.27},{sym:'NVDA',name:'NVIDIA',price:875.20,chg:12.45,pct:1.44},{sym:'AMZN',name:'Amazon',price:218.90,chg:3.21,pct:1.49},{sym:'TSLA',name:'Tesla',price:342.15,chg:-8.90,pct:-2.53}];
const FUNDS=[{name:'Vanguard 500',tick:'VFIAX',nav:523.45,ytd:12.8,exp:0.04},{name:'Fidelity Growth',tick:'FDGRX',nav:248.90,ytd:18.2,exp:0.52},{name:'Schwab Total',tick:'SWTSX',nav:82.15,ytd:11.5,exp:0.03},{name:'T.Rowe Blue',tick:'TRBCX',nav:178.30,ytd:15.1,exp:0.69}];
const BONDS=[{name:'US 10Y Treasury',yld:4.32,price:98.45,rat:'AAA',chg:-0.05},{name:'US 30Y Treasury',yld:4.58,price:95.20,rat:'AAA',chg:0.02},{name:'Corp Bond AAA',yld:5.12,price:102.30,rat:'AAA',chg:-0.08},{name:'Muni Bond',yld:3.85,price:104.15,rat:'AA+',chg:0.03}];
const STARTUPS=[{name:'NeuroLink AI',stage:'Series B',raised:'$45M',yc:'W24',val:'$280M',logo:'ğŸ§ '},{name:'CarbonZero',stage:'Series A',raised:'$18M',yc:'S23',val:'$95M',logo:'ğŸŒ±'},{name:'QuantumLeap',stage:'Seed',raised:'$5M',yc:'W25',val:'$32M',logo:'âš›ï¸'},{name:'MediScan',stage:'Series A',raised:'$22M',yc:'S24',val:'$120M',logo:'ğŸ”¬'},{name:'BlockSecure',stage:'Series B',raised:'$38M',yc:'W23',val:'$210M',logo:'ğŸ”—'},{name:'AgriDrone',stage:'Seed',raised:'$8M',yc:'S25',val:'$48M',logo:'ğŸŒ¾'}];
const INSURANCE=[{name:'Whole Life',prov:'MetLife',prem:'$250/mo',cov:'$500K',type:'Life'},{name:'Term 20Y',prov:'Prudential',prem:'$85/mo',cov:'$1M',type:'Life'},{name:'Health Shield+',prov:'Aetna',prem:'$420/mo',cov:'Full',type:'Health'},{name:'Property Guard',prov:'State Farm',prem:'$180/mo',cov:'$350K',type:'Property'}];
const VENDORS=[{name:'Vanguard',url:'https://vanguard.com',desc:'Index funds',icon:'ğŸ“Š'},{name:'Fidelity',url:'https://fidelity.com',desc:'Investing',icon:'ğŸ’¼'},{name:'Schwab',url:'https://schwab.com',desc:'Stocks',icon:'ğŸ¦'},{name:'Robinhood',url:'https://robinhood.com',desc:'Free trades',icon:'ğŸ“ˆ'},{name:'Coinbase',url:'https://coinbase.com',desc:'Crypto',icon:'â‚¿'},{name:'Betterment',url:'https://betterment.com',desc:'Robo-advisor',icon:'ğŸ¤–'}];
const INSIGHTS=[{title:'Dining up 23%',desc:'Meal prep could save ~$180/mo.',type:'warn',save:180},{title:'Sub overlap',desc:'Rotate streaming: save $26/mo.',type:'tip',save:26},{title:'Savings streak!',desc:'Emergency fund on track for April.',type:'good',save:0},{title:'Utilities down 12%',desc:'Smart thermostat working.',type:'good',save:35},{title:'Invest tip',desc:'$200/mo in VFIAX = ~$28K in 10y.',type:'tip',save:0}];

// ==== RENDER: Nav, Landing, Auth ====
function renderNav(){return'<nav style="position:fixed;top:0;left:0;right:0;z-index:100;padding:14px 36px;display:flex;align-items:center;justify-content:space-between;background:rgba(6,6,16,.75);backdrop-filter:blur(20px);border-bottom:1px solid var(--bd)"><div style="display:flex;align-items:center;gap:9"><div style="width:32px;height:32px;border-radius:9px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#5b8cff,#b07cff);font-size:15px;font-weight:700;color:#fff">V</div><span style="font-size:18px;font-weight:700">VisionFi</span><span class="badge" style="background:var(--blue-g);color:var(--blue);font-size:9px">VISA</span></div><div style="display:flex;gap:7"><button class="btn btn-g" onclick="set({page:\'auth\',authMode:\'login\'})">Sign In</button><button class="btn btn-p" onclick="set({page:\'auth\',authMode:\'register\'})">Get Started</button></div></nav>'}

function renderLanding(){return renderNav()+'<section style="position:relative;min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:110px 24px 80px;overflow:hidden"><div class="orb" style="background:#5b8cff;width:450px;height:450px;top:-8%;left:18%;animation:orb1 14s infinite"></div><div class="orb" style="background:#b07cff;width:380px;height:380px;top:32%;left:62%;animation:orb2 14s infinite"></div><div class="orb" style="background:#3ddba0;width:320px;height:320px;top:58%;left:8%"></div><div style="display:inline-flex;align-items:center;gap:7;padding:5px 14px;border-radius:18px;background:var(--blue-g);border:1px solid rgba(91,140,255,.18);margin-bottom:28px;animation:fadeIn .6s"><span style="font-size:12px;color:var(--t2)">âœ¦ CMU Hackathon 2026 Â· VISA Challenge</span></div><h1 class="serif" style="font-size:clamp(38px,6.5vw,72px);font-weight:400;line-height:1.06;max-width:840px;margin-bottom:22px;animation:slideUp .8s;letter-spacing:-2px">Your money,<br><span style="background:linear-gradient(135deg,#5b8cff,#b07cff,#3ddba0);background-size:200% 200%;animation:gradShift 4s infinite;-webkit-background-clip:text;-webkit-text-fill-color:transparent">brilliantly organized</span></h1><p style="font-size:17px;color:var(--t2);max-width:520px;line-height:1.65;margin-bottom:36px;animation:slideUp 1s">Budget planner with credit tracking, AI insights, predictions & investments.</p><div style="display:flex;gap:12px;animation:slideUp 1.2s;flex-wrap:wrap;justify-content:center"><button class="btn btn-p" style="padding:15px 36px;font-size:15px;border-radius:13px" onclick="set({page:\'auth\',authMode:\'register\'})">Start Free â†’</button><button class="btn btn-g" style="padding:15px 36px;font-size:15px;border-radius:13px" onclick="set({page:\'auth\',authMode:\'login\'})">Sign In</button></div></section><section style="padding:80px 24px;max-width:1120px;margin:0 auto"><div class="grid gf" style="gap:14px">'+[{i:'ğŸ“Š',t:'Smart Budgets',d:'AI categorizes transactions.'},{i:'ğŸ’³',t:'Credit Tracking',d:'Full credit history, cards & loans.'},{i:'ğŸ”®',t:'ML Predictions',d:'Daily/weekly/monthly forecasts.'},{i:'ğŸ“ˆ',t:'Investments',d:'Stocks, funds, bonds.'},{i:'ğŸ¤–',t:'Claude AI',d:'Real AI financial advisor.'},{i:'ğŸ¯',t:'Goals',d:'Track savings progress.'}].map(function(f){return'<div class="card"><div style="font-size:28px;margin-bottom:12px">'+f.i+'</div><h3 style="font-size:16px;font-weight:600;margin-bottom:5px">'+f.t+'</h3><p style="font-size:13px;color:var(--t2)">'+f.d+'</p></div>'}).join('')+'</div></section><footer style="padding:32px 24px;border-top:1px solid var(--bd);text-align:center;color:var(--t3);font-size:11px">Â© 2026 VisionFi Â· VISA Â· CMU</footer>'}

function renderAuth(){var isR=state.authMode==='register';return'<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;position:relative;overflow:hidden"><div class="orb" style="background:#5b8cff;width:450px;height:450px;top:8%;left:8%"></div><div class="orb" style="background:#b07cff;width:380px;height:380px;top:48%;left:62%"></div><div style="width:100%;max-width:400px;position:relative;z-index:1;animation:fadeIn .5s"><div style="display:flex;align-items:center;gap:9;margin-bottom:36px;justify-content:center;cursor:pointer" onclick="set({page:\'landing\'})"><div style="width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#5b8cff,#b07cff);font-size:17px;font-weight:700;color:#fff">V</div><span style="font-size:21px;font-weight:700">VisionFi</span></div><div style="padding:28px;border-radius:16px;background:rgba(11,11,22,.85);border:1px solid var(--bd);backdrop-filter:blur(20px)"><h2 style="font-size:21px;font-weight:700;margin-bottom:22px">'+(isR?'Create account':'Welcome back')+'</h2><div id="auth-error" class="err-msg"></div><form id="auth-form" style="display:flex;flex-direction:column;gap:12px">'+(isR?'<div><label class="label">Name</label><input class="input" id="auth-name" required/></div>':'')+'<div><label class="label">Email</label><input class="input" id="auth-email" type="email" value="alex@cmu.edu" required/></div><div><label class="label">Password</label><input class="input" id="auth-pass" type="password" value="demo123" required/></div>'+(isR?'<div><label class="label">Income</label><input class="input" id="auth-income" type="number" placeholder="7500"/></div>':'')+'<button type="submit" class="btn btn-p" style="width:100%;padding:13px">'+(isR?'Create Account':'Sign In')+'</button><p style="text-align:center;font-size:10px;color:var(--t3);margin-top:4px">Demo: alex@cmu.edu / sarah@gmail.com / jay@cmu.edu (pw: demo123)</p></form></div><p style="text-align:center;margin-top:16px;font-size:12px;color:var(--t3)">'+(isR?'Have account? ':'No account? ')+'<span style="color:var(--blue);cursor:pointer" onclick="set({authMode:\''+(isR?'login':'register')+'\'})\">'+(isR?'Sign In':'Sign Up')+'</span></p></div></div>'}

function renderSidebar(){var u=state.currentUser;if(!u)return'';var tabs=[{id:'dashboard',l:'Dashboard',i:'ğŸ“Š'},{id:'credit',l:'Credit & Loans',i:'ğŸ’³'},{id:'investments',l:'Investments',i:'ğŸ“ˆ'},{id:'insights',l:'Insights',i:'ğŸ’¡'},{id:'predictions',l:'Predictions',i:'ğŸ”®'}];return'<div class="sidebar" style="width:240px;min-height:100vh;background:var(--bg1);border-right:1px solid var(--bd);display:flex;flex-direction:column;padding:16px 10px;position:fixed;left:0;top:0;z-index:50"><div style="display:flex;align-items:center;gap:8;padding:7px 11px;margin-bottom:26px"><div style="width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#5b8cff,#b07cff);font-size:14px;font-weight:700;color:#fff">V</div><span style="font-size:16px;font-weight:700">VisionFi</span></div><div style="flex:1;display:flex;flex-direction:column;gap:2px">'+tabs.map(function(t){return'<button onclick="set({tab:\''+t.id+'\'})" style="display:flex;align-items:center;gap:9;padding:10px 12px;border-radius:8px;border:none;cursor:pointer;width:100%;text-align:left;background:'+(state.tab===t.id?'var(--blue-g)':'transparent')+';color:'+(state.tab===t.id?'var(--blue)':'var(--t2)')+';font-size:13px;font-weight:'+(state.tab===t.id?600:400)+';font-family:inherit"><span>'+t.i+'</span>'+t.l+'</button>'}).join('')+'</div><div style="position:relative"><div id="user-menu" style="display:none;position:absolute;bottom:100%;left:0;right:0;margin-bottom:5px;background:var(--bg3);border:1px solid var(--bd2);border-radius:11px;padding:5px;box-shadow:0 8px 32px rgba(0,0,0,.5)">'+state.users.map(function(usr){return'<button onclick="switchUser(\''+usr.id+'\')" style="display:flex;align-items:center;gap:8;padding:8px 9px;border-radius:6px;border:none;cursor:pointer;width:100%;background:'+(usr.id===u.id?'var(--blue-g)':'transparent')+';color:var(--t1);font-size:11px;text-align:left;font-family:inherit"><span style="font-size:17px">'+usr.avatar+'</span><div><div style="font-weight:500">'+usr.name+'</div><div style="font-size:9px;color:var(--t3)">'+(usr.tier==='premium'?'â˜… Premium':'Free')+'</div></div></button>'}).join('')+'<div style="height:1px;background:var(--bd);margin:4px 0"></div><button onclick="set({page:\'landing\',currentUser:null})" style="display:flex;align-items:center;gap:7;padding:8px 9px;border-radius:6px;border:none;cursor:pointer;width:100%;background:transparent;color:var(--red);font-size:11px;text-align:left;font-family:inherit">ğŸšª Sign Out</button></div><button onclick="var m=document.getElementById(\'user-menu\');m.style.display=m.style.display===\'block\'?\'none\':\'block\'" style="display:flex;align-items:center;gap:8;padding:9px;border-radius:10px;border:1px solid var(--bd);cursor:pointer;width:100%;background:var(--bg2);color:var(--t1);text-align:left;font-family:inherit"><span style="font-size:20px">'+u.avatar+'</span><div style="flex:1"><div style="font-size:11px;font-weight:600">'+u.name+'</div><div style="font-size:9px;color:var(--t3)">'+(u.tier==='premium'?'â˜… Premium':'Free')+'</div></div><span style="color:var(--t3)">â–¾</span></button></div></div>'}

function renderDashboard(){var d=state.dashData;if(!d)return'';var u=d.user,s=d.stats,cats=d.categoryBreakdown;var icons={'Housing':'ğŸ ','Food & Dining':'ğŸ½ï¸','Transport':'ğŸš—','Entertainment':'ğŸ¬','Shopping':'ğŸ›ï¸','Subscriptions':'ğŸ“±','Healthcare':'ğŸ¥','Utilities':'ğŸ’¡'};var colors={'Housing':'#5b8cff','Food & Dining':'#3ddba0','Transport':'#ffb84d','Entertainment':'#b07cff','Shopping':'#ff7eb3','Subscriptions':'#4dd4c0','Healthcare':'#ff6b6b','Utilities':'#60a5fa'};var hr=new Date().getHours(),g=hr<12?'morning':hr<18?'afternoon':'evening';return'<div style="animation:fadeIn .35s"><h1 style="font-size:24px;font-weight:700;margin-bottom:20px">Good '+g+', '+u.name.split(' ')[0]+'</h1><div class="grid g4" style="margin-bottom:16px">'+[{l:'Net Worth',v:fmt(s.netWorth),b:'â†‘ +$4,230'},{l:'Income',v:fmt(u.income),b:'Stable'},{l:'Spent',v:fmt(s.totalSpent),b:'â†“ -8.2%'},{l:'Savings',v:s.savingsRate+'%',b:'â†‘ +5.1%'}].map(function(x){return'<div class="card"><div style="font-size:10px;color:var(--t3);margin-bottom:7px;text-transform:uppercase;letter-spacing:.5px">'+x.l+'</div><div style="font-size:24px;font-weight:700;letter-spacing:-1px;margin-bottom:5px">'+x.v+'</div><span class="badge" style="color:var(--green);background:var(--green-g)">'+x.b+'</span></div>'}).join('')+'</div><div class="grid g2" style="margin-bottom:16px"><div class="card"><h3 style="font-size:14px;font-weight:600;margin-bottom:14px">Cash Flow</h3><canvas id="chart-cf" style="width:100%;height:220px"></canvas></div><div class="card"><h3 style="font-size:14px;font-weight:600;margin-bottom:14px">Budget Breakdown</h3><div style="display:flex;flex-direction:column;gap:9px">'+cats.map(function(c){var pct=Math.min((c.spent/c.budget)*100,100),ov=c.spent>c.budget;return'<div><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:11px">'+(icons[c.category]||'ğŸ’³')+' '+c.category+'</span><span class="mono" style="font-size:10px;color:'+(ov?'var(--red)':'var(--t2)')+'">'+fmt(c.spent)+'/'+fmt(c.budget)+'</span></div><div style="height:4px;border-radius:2px;background:rgba(255,255,255,.04);overflow:hidden"><div style="height:100%;width:'+pct+'%;background:'+(ov?'var(--red)':(colors[c.category]||'var(--blue)'))+'"></div></div></div>'}).join('')+'</div></div></div><div style="display:grid;grid-template-columns:1.15fr .85fr;gap:14px"><div class="card"><div style="display:flex;justify-content:space-between;margin-bottom:14px"><h3 style="font-size:14px;font-weight:600">Transactions</h3><button class="btn btn-p btn-sm" onclick="set({showAddTx:true})">+ Add</button></div>'+d.transactions.slice(0,10).map(function(tx){return'<div style="display:flex;align-items:center;justify-content:space-between;padding:7px 4px"><div style="display:flex;align-items:center;gap:8"><span style="font-size:14px">'+tx.icon+'</span><div><div style="font-size:12px;font-weight:500">'+tx.name+'</div><div style="font-size:9px;color:var(--t3)">'+tx.category+' Â· '+tx.date+'</div></div></div><span class="mono" style="font-size:12px;font-weight:600;color:'+(tx.amount>0?'var(--green)':'var(--t1)')+'">'+(tx.amount>0?'+':'')+fmt(tx.amount)+'</span></div>'}).join('')+'</div><div class="card"><h3 style="font-size:14px;font-weight:600;margin-bottom:12px">Subscriptions Â· '+fmt(s.subTotal)+'/mo</h3>'+d.subscriptions.map(function(sub){return'<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0"><div style="display:flex;align-items:center;gap:8"><span>'+sub.icon+'</span><div><div style="font-size:11px;font-weight:500">'+sub.name+'</div><div style="font-size:9px;color:var(--t3)">'+sub.next_date+'</div></div></div><span class="mono" style="font-size:11px;color:var(--t2)">'+fmt(sub.amount)+'</span></div>'}).join('')+'</div></div></div>'}

// ==== CREDIT & LOANS TAB ====
function renderCredit(){var d=state.dashData;if(!d)return'';var cr=d.creditReport,cards=d.creditCards,loans=d.loans,ccSpend=d.creditSpending,s=d.stats,sub=state.creditSub;
var tabs=[{id:'overview',l:'Overview'},{id:'cards',l:'Credit Cards'},{id:'loans',l:'Loans & EMIs'},{id:'spending',l:'Card Spending'},{id:'history',l:'History'}];
var html='<div style="animation:fadeIn .35s"><h1 style="font-size:24px;font-weight:700;margin-bottom:18px">Credit & Loans</h1><div style="display:inline-flex;gap:2px;padding:3px;border-radius:10px;background:var(--bg1);margin-bottom:18px;border:1px solid var(--bd)">'+tabs.map(function(t){return'<button onclick="set({creditSub:\''+t.id+'\'})" style="padding:8px 14px;border-radius:7px;border:none;cursor:pointer;background:'+(sub===t.id?'var(--bg2)':'transparent')+';color:'+(sub===t.id?'var(--t1)':'var(--t3)')+';font-size:11px;font-weight:'+(sub===t.id?600:400)+';font-family:inherit">'+t.l+'</button>'}).join('')+'</div>';

if(sub==='overview'&&cr){
  html+='<div class="grid g2" style="margin-bottom:16px"><div class="card" style="display:flex;align-items:center;gap:24px">'+scoreSVG(cr.credit_score)+'<div><div style="font-size:20px;font-weight:700;color:'+scoreColor(cr.credit_score)+'">'+cr.score_rating+'</div><div style="font-size:11px;color:var(--t3)">Updated '+cr.last_updated+'</div><div style="display:flex;gap:12px;margin-top:10px">'+[{l:'On-Time',v:cr.on_time_pct+'%',c:'var(--green)'},{l:'Util.',v:cr.credit_utilization+'%',c:cr.credit_utilization>30?'var(--amber)':'var(--green)'},{l:'Inquiries',v:cr.hard_inquiries,c:'var(--t1)'}].map(function(x){return'<div style="text-align:center"><div class="mono" style="font-size:14px;font-weight:600;color:'+x.c+'">'+x.v+'</div><div style="font-size:9px;color:var(--t3)">'+x.l+'</div></div>'}).join('')+'</div></div></div><div class="card"><h3 style="font-size:14px;font-weight:600;margin-bottom:14px">Account Summary</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">'+[{l:'Total Accounts',v:cr.total_accounts},{l:'Open',v:cr.open_accounts},{l:'Closed',v:cr.closed_accounts},{l:'Credit Age',v:cr.credit_age_years+'y'},{l:'Total Limit',v:fmt(cr.total_credit_limit)},{l:'Total Balance',v:fmt(cr.total_balance)},{l:'Derogatory',v:cr.derogatory_marks},{l:'Oldest',v:cr.oldest_account}].map(function(x){return'<div><div style="font-size:9px;color:var(--t3);text-transform:uppercase;margin-bottom:2px">'+x.l+'</div><div class="mono" style="font-size:14px;font-weight:600">'+x.v+'</div></div>'}).join('')+'</div></div></div>';
  html+='<div class="grid g4">'+[{l:'Cards',v:s.cardCount,i:'ğŸ’³',c:'var(--blue)'},{l:'Card Balance',v:fmt(s.totalCreditBalance),i:'ğŸ’°',c:'var(--amber)'},{l:'Loans',v:s.loanCount,i:'ğŸ“‹',c:'var(--purple)'},{l:'Monthly EMI',v:fmt(s.totalEMI),i:'ğŸ“…',c:'var(--red)'}].map(function(x){return'<div class="card" style="text-align:center"><div style="font-size:22px;margin-bottom:6px">'+x.i+'</div><div class="mono" style="font-size:20px;font-weight:700;color:'+x.c+'">'+x.v+'</div><div style="font-size:10px;color:var(--t3);margin-top:2px">'+x.l+'</div></div>'}).join('')+'</div>';
}
if(sub==='cards'){
  html+='<div class="grid gf">'+cards.map(function(c){var util=Math.round(c.current_balance/c.credit_limit*100);var uc=util>50?'var(--red)':util>30?'var(--amber)':'var(--green)';return'<div class="credit-card-visual"><div style="display:flex;justify-content:space-between;margin-bottom:18px"><div><div style="font-size:14px;font-weight:600">'+c.card_name+'</div><div style="font-size:10px;color:var(--t3)">'+c.issuer+' Â· '+c.card_type+'</div></div><span class="badge" style="background:var(--blue-g);color:var(--blue)">'+c.rewards_rate+'% '+c.rewards_type+'</span></div><div style="display:flex;align-items:center;gap:10px;margin-bottom:16px"><div class="cc-chip"></div><div class="mono" style="font-size:15px;letter-spacing:3px;color:var(--t2)">â€¢â€¢â€¢â€¢ '+c.last_four+'</div></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px"><div><div style="font-size:9px;color:var(--t3);text-transform:uppercase;margin-bottom:2px">Balance</div><div class="mono" style="font-size:15px;font-weight:700">'+fmt(c.current_balance)+'</div></div><div><div style="font-size:9px;color:var(--t3);text-transform:uppercase;margin-bottom:2px">Limit</div><div class="mono" style="font-size:15px;font-weight:600">'+fmt(c.credit_limit)+'</div></div><div><div style="font-size:9px;color:var(--t3);text-transform:uppercase;margin-bottom:2px">Util.</div><div class="mono" style="font-size:15px;font-weight:600;color:'+uc+'">'+util+'%</div></div></div><div style="height:4px;border-radius:2px;background:rgba(255,255,255,.06);margin-top:12px"><div style="height:100%;width:'+util+'%;background:'+uc+';border-radius:2px"></div></div><div style="display:flex;justify-content:space-between;margin-top:10px;font-size:10px;color:var(--t3)"><span>Min: '+fmt(c.min_payment)+'</span><span>APR: '+c.apr+'%</span><span>Due: '+c.due_date+'</span></div></div>'}).join('')+'</div>';
}
if(sub==='loans'){
  html+='<div style="margin-bottom:16px;padding:16px;background:var(--bg2);border:1px solid var(--bd);border-radius:12px;display:flex;justify-content:space-around;text-align:center">'+[{l:'Total Debt',v:fmt(s.totalLoanBalance),c:'var(--red)'},{l:'Monthly EMI',v:fmt(s.totalEMI),c:'var(--amber)'},{l:'Active Loans',v:s.loanCount,c:'var(--blue)'}].map(function(x){return'<div><div style="font-size:10px;color:var(--t3);text-transform:uppercase;margin-bottom:4px">'+x.l+'</div><div class="mono" style="font-size:22px;font-weight:700;color:'+x.c+'">'+x.v+'</div></div>'}).join('')+'</div>';
  html+='<div style="display:flex;flex-direction:column;gap:12px">'+loans.map(function(l){var pct=Math.round(l.months_paid/l.tenure_months*100);var ti={'Student':'ğŸ“','Auto':'ğŸš—','Personal':'ğŸ’°','Mortgage':'ğŸ '}[l.loan_type]||'ğŸ“‹';var tc={'Student':'var(--blue)','Auto':'var(--amber)','Personal':'var(--green)','Mortgage':'var(--purple)'}[l.loan_type]||'var(--t1)';return'<div class="card loan-card"><div style="display:flex;justify-content:space-between;margin-bottom:12px"><div style="display:flex;align-items:center;gap:10px"><div style="width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:var(--bg1);font-size:18px;border:1px solid var(--bd)">'+ti+'</div><div><div style="font-size:15px;font-weight:600">'+l.loan_name+'</div><div style="font-size:10px;color:var(--t3)">'+l.lender+' Â· '+l.loan_type+'</div></div></div><span class="badge" style="background:var(--green-g);color:var(--green)">Active</span></div><div class="grid g4" style="gap:10px;margin-bottom:12px">'+[{l:'Original',v:fmt(l.original_amount)},{l:'Remaining',v:fmt(l.remaining_balance)},{l:'Rate',v:l.interest_rate+'%'},{l:'EMI',v:fmt(l.emi_amount)}].map(function(x){return'<div><div style="font-size:9px;color:var(--t3);text-transform:uppercase;margin-bottom:2px">'+x.l+'</div><div class="mono" style="font-size:13px;font-weight:600">'+x.v+'</div></div>'}).join('')+'</div><div style="display:flex;justify-content:space-between;margin-bottom:6px;font-size:10px;color:var(--t2)"><span>'+l.months_paid+'/'+l.tenure_months+' months ('+pct+'%)</span><span>Next EMI: '+l.next_emi_date+'</span></div><div style="height:6px;border-radius:3px;background:rgba(255,255,255,.04)"><div style="height:100%;width:'+pct+'%;background:'+tc+';border-radius:3px"></div></div></div>'}).join('')+'</div>';
}
if(sub==='spending'){
  html+='<div style="border-radius:13px;background:var(--bg2);border:1px solid var(--bd);overflow:hidden"><table style="width:100%;border-collapse:collapse"><thead><tr style="border-bottom:1px solid var(--bd)">'+['','Merchant','Card','Amount','Date','Category'].map(function(h){return'<th style="padding:10px 14px;text-align:left;font-size:10px;color:var(--t3);text-transform:uppercase">'+h+'</th>'}).join('')+'</tr></thead><tbody>'+ccSpend.map(function(sp){var card=cards.find(function(c){return c.id===sp.card_id});return'<tr style="border-bottom:1px solid rgba(255,255,255,.03)"><td style="padding:10px 14px">'+sp.icon+'</td><td style="padding:10px 14px;font-size:12px;font-weight:500">'+sp.merchant+'</td><td style="padding:10px 14px;font-size:11px;color:var(--t3)">'+(card?'â€¢â€¢'+card.last_four:'')+'</td><td class="mono" style="padding:10px 14px;font-size:12px;font-weight:600;color:var(--red)">'+fmt(Math.abs(sp.amount))+'</td><td style="padding:10px 14px;font-size:11px;color:var(--t3)">'+sp.date+'</td><td style="padding:10px 14px"><span class="badge" style="background:var(--bg4);color:var(--t2)">'+sp.category+'</span></td></tr>'}).join('')+'</tbody></table></div>';
}
if(sub==='history'&&cr){
  html+='<div class="card" style="margin-bottom:16px"><h3 style="font-size:14px;font-weight:600;margin-bottom:14px">Score Trend (7 months)</h3><canvas id="chart-credit" style="width:100%;height:240px"></canvas></div>';
  html+='<div class="grid g2"><div class="card"><h3 style="font-size:14px;font-weight:600;margin-bottom:12px">Factors Helping âœ…</h3>'+[{f:'On-time payments',v:cr.on_time_pct+'%'},{f:'Credit age',v:cr.credit_age_years+' years'},{f:'Account mix',v:cr.total_accounts+' accounts'}].map(function(x){return'<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--bd)"><span style="font-size:12px">'+x.f+'</span><span class="mono" style="font-size:12px;color:var(--green)">'+x.v+'</span></div>'}).join('')+'</div><div class="card"><h3 style="font-size:14px;font-weight:600;margin-bottom:12px">Needs Work âš ï¸</h3>'+[{f:'Utilization',v:cr.credit_utilization+'%',c:cr.credit_utilization>30?'var(--amber)':'var(--green)'},{f:'Hard inquiries',v:cr.hard_inquiries,c:cr.hard_inquiries>2?'var(--amber)':'var(--green)'},{f:'Derogatory marks',v:cr.derogatory_marks,c:cr.derogatory_marks>0?'var(--red)':'var(--green)'}].map(function(x){return'<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--bd)"><span style="font-size:12px">'+x.f+'</span><span class="mono" style="font-size:12px;color:'+x.c+'">'+x.v+'</span></div>'}).join('')+'</div></div>';
}
return html+'</div>';}

// ==== INVESTMENTS ====
function renderInvestments(){var u=state.currentUser,prem=u&&u.tier==='premium',sub=state.investSub;var tabs=[{id:'stocks',l:'Stocks',f:1},{id:'funds',l:'Funds',f:1},{id:'bonds',l:'Bonds',f:1},{id:'startups',l:'Startups',f:0},{id:'insurance',l:'Insurance',f:0}];var lock=function(t){return'<div style="position:relative"><div style="filter:blur(5px);opacity:.3"><div class="grid g3">'+Array(6).fill('<div style="height:150px;border-radius:12px;background:var(--bg2)"></div>').join('')+'</div></div><div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center"><div style="padding:18px 26px;background:var(--bg3);border-radius:13px;text-align:center;border:1px solid var(--bd)"><div style="font-size:28px;margin-bottom:8px">ğŸ”’</div><h3 style="font-size:16px;font-weight:600">Premium</h3></div></div></div>'};var html='<div style="animation:fadeIn .35s"><h1 style="font-size:24px;font-weight:700;margin-bottom:18px">Investments</h1><div style="display:inline-flex;gap:2px;padding:3px;border-radius:10px;background:var(--bg1);margin-bottom:16px;border:1px solid var(--bd)">'+tabs.map(function(t){return'<button onclick="set({investSub:\''+t.id+'\'})" style="padding:8px 15px;border-radius:7px;border:none;cursor:pointer;background:'+(sub===t.id?'var(--bg2)':'transparent')+';color:'+(sub===t.id?'var(--t1)':'var(--t3)')+';font-size:11px;font-weight:'+(sub===t.id?600:400)+';font-family:inherit">'+t.l+(!t.f?' â˜…':'')+'</button>'}).join('')+'</div>';
if(sub==='stocks')html+='<div class="grid gf">'+STOCKS.map(function(s){return'<div class="card" style="padding:16px"><div style="display:flex;justify-content:space-between;margin-bottom:9px"><div><div class="mono" style="font-size:14px;font-weight:700">'+s.sym+'</div><div style="font-size:10px;color:var(--t3)">'+s.name+'</div></div>'+sparkSVG(s.chg>=0?'#3ddba0':'#ff6b6b')+'</div><div style="display:flex;justify-content:space-between;align-items:flex-end"><span class="mono" style="font-size:19px;font-weight:700">$'+s.price.toFixed(2)+'</span><span class="badge" style="color:'+(s.chg>=0?'var(--green)':'var(--red)')+';background:'+(s.chg>=0?'var(--green-g)':'var(--red-g)')+'">'+(s.chg>=0?'+':'')+s.chg.toFixed(2)+'</span></div></div>'}).join('')+'</div>';
else if(sub==='funds')html+='<div style="border-radius:13px;background:var(--bg2);border:1px solid var(--bd);overflow:hidden"><table style="width:100%;border-collapse:collapse"><thead><tr style="border-bottom:1px solid var(--bd)">'+['Fund','Ticker','NAV','YTD','Exp'].map(function(h){return'<th style="padding:11px 16px;text-align:left;font-size:10px;color:var(--t3)">'+h+'</th>'}).join('')+'</tr></thead><tbody>'+FUNDS.map(function(f){return'<tr style="border-bottom:1px solid rgba(255,255,255,.03)"><td style="padding:13px 16px;font-size:12px;font-weight:500">'+f.name+'</td><td class="mono" style="padding:13px 16px;color:var(--blue)">'+f.tick+'</td><td class="mono" style="padding:13px 16px">$'+f.nav.toFixed(2)+'</td><td style="padding:13px 16px;color:var(--green);font-weight:600">+'+f.ytd+'%</td><td style="padding:13px 16px;color:var(--t3)">'+f.exp+'%</td></tr>'}).join('')+'</tbody></table></div>';
else if(sub==='bonds')html+='<div class="grid gf">'+BONDS.map(function(b){return'<div class="card"><div style="font-size:13px;font-weight:600;margin-bottom:9px">'+b.name+'</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:9px"><div><div style="font-size:9px;color:var(--t3);text-transform:uppercase">Yield</div><div class="mono" style="font-size:17px;font-weight:600;color:var(--green)">'+b.yld+'%</div></div><div><div style="font-size:9px;color:var(--t3);text-transform:uppercase">Price</div><div class="mono" style="font-size:17px;font-weight:600">$'+b.price+'</div></div></div></div>'}).join('')+'</div>';
else if(sub==='startups')html+=prem?'<div class="grid gf">'+STARTUPS.map(function(s){return'<div class="card"><div style="display:flex;align-items:center;gap:9;margin-bottom:12px"><span style="font-size:22px">'+s.logo+'</span><div><div style="font-size:14px;font-weight:600">'+s.name+'</div><span class="badge" style="background:var(--amber-g);color:#fb8f24">YC '+s.yc+'</span></div></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:9px">'+[{l:'Stage',v:s.stage},{l:'Raised',v:s.raised},{l:'Val',v:s.val}].map(function(d){return'<div><div style="font-size:8px;color:var(--t3);text-transform:uppercase">'+d.l+'</div><div style="font-size:12px;font-weight:600">'+d.v+'</div></div>'}).join('')+'</div></div>'}).join('')+'</div>':lock('Startups');
else html+=prem?'<div class="grid gf">'+INSURANCE.map(function(ins){return'<div class="card"><span class="badge" style="margin-bottom:8px;background:var(--purple-g);color:var(--purple)">'+ins.type+'</span><div style="font-size:14px;font-weight:600">'+ins.name+'</div><div style="font-size:11px;color:var(--t3);margin-bottom:12px">'+ins.prov+'</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:9px"><div><div style="font-size:8px;color:var(--t3)">Premium</div><div class="mono" style="font-size:12px;font-weight:600">'+ins.prem+'</div></div><div><div style="font-size:8px;color:var(--t3)">Coverage</div><div class="mono" style="font-size:12px;font-weight:600">'+ins.cov+'</div></div></div></div>'}).join('')+'</div>':lock('Insurance');
return html+'</div>';}

// ==== INSIGHTS ====
function renderInsights(){return'<div style="animation:fadeIn .35s"><h1 style="font-size:24px;font-weight:700;margin-bottom:20px">Insights</h1><div style="display:flex;flex-direction:column;gap:9px;margin-bottom:26px">'+INSIGHTS.map(function(ins){return'<div class="card" style="display:flex;gap:12px;border-left:3px solid '+(ins.type==='warn'?'var(--amber)':ins.type==='good'?'var(--green)':'var(--blue)')+'"><div style="font-size:20px">'+(ins.type==='warn'?'âš ï¸':ins.type==='good'?'âœ…':'ğŸ’¡')+'</div><div style="flex:1"><div style="font-size:13px;font-weight:600;margin-bottom:2px">'+ins.title+'</div><div style="font-size:11px;color:var(--t2)">'+ins.desc+'</div>'+(ins.save?'<span class="badge" style="margin-top:6px;background:var(--green-g);color:var(--green)">ğŸ’° '+fmt(ins.save)+'/mo</span>':'')+'</div></div>'}).join('')+'</div><h2 style="font-size:17px;font-weight:700;margin-bottom:12px">Partners</h2><div class="grid gf" style="gap:9px">'+VENDORS.map(function(v){return'<a href="'+v.url+'" target="_blank" class="card" style="display:flex;align-items:center;gap:11px;padding:14px"><span style="font-size:24px">'+v.icon+'</span><div style="flex:1"><div style="font-size:12px;font-weight:600">'+v.name+'</div><div style="font-size:10px;color:var(--t3)">'+v.desc+'</div></div><span style="color:var(--t3)">â†—</span></a>'}).join('')+'</div></div>';}

// ==== PREDICTIONS (Interactive hover) ====
function renderPredictions(){var p=state.predPeriod;var summ={daily:{pred:'$142',conf:'87%',save:'$18/day',risk:'Low',trend:'-3.2% vs last week',pDetail:'Based on 30-day spending pattern analysis',cDetail:'High confidence from consistent daily patterns',sDetail:'Reduce dining out by 1 meal/day',rDetail:'Well within budget guardrails'},weekly:{pred:'$994',conf:'82%',save:'$106/wk',risk:'Medium',trend:'+1.8% vs last month',pDetail:'Aggregated from daily transaction forecasts',cDetail:'Moderate â€” weekends add variance',sDetail:'Batch cook on Sundays to cut grocery trips',rDetail:'Shopping spikes possible'},monthly:{pred:'$4,180',conf:'78%',save:'$420/mo',risk:'Low',trend:'-8.2% improving',pDetail:'Income minus projected recurring expenses',cDetail:'Lower due to variable expenses',sDetail:'Automate $420 to savings on payday',rDetail:'Stable income, predictable bills'}};var s=summ[p];
return'<div style="animation:fadeIn .35s"><h1 style="font-size:24px;font-weight:700;margin-bottom:18px">Budget Predictions</h1><div style="display:inline-flex;gap:2px;padding:3px;border-radius:10px;background:var(--bg1);margin-bottom:18px;border:1px solid var(--bd)">'+['daily','weekly','monthly'].map(function(pp){return'<button onclick="set({predPeriod:\''+pp+'\'})" style="padding:8px 20px;border-radius:7px;border:none;cursor:pointer;background:'+(p===pp?'var(--bg2)':'transparent')+';color:'+(p===pp?'var(--t1)':'var(--t3)')+';font-size:11px;font-weight:'+(p===pp?600:400)+';text-transform:capitalize;font-family:inherit">'+pp+'</button>'}).join('')+'</div>'+
'<div class="grid g4" style="margin-bottom:18px">'+[{l:'Predicted',v:s.pred,i:'ğŸ“Š',c:'var(--blue)',d:s.pDetail,tr:s.trend},{l:'Confidence',v:s.conf,i:'ğŸ¯',c:'var(--purple)',d:s.cDetail,tr:'6mo data basis'},{l:'Savings Opp.',v:s.save,i:'ğŸ’°',c:'var(--green)',d:s.sDetail,tr:'If optimized'},{l:'Risk Level',v:s.risk,i:'ğŸ›¡ï¸',c:s.risk==='Low'?'var(--green)':'var(--amber)',d:s.rDetail,tr:'Within budget'}].map(function(x){return'<div class="card pred-stat" style="position:relative;overflow:hidden"><div style="font-size:10px;color:var(--t3);margin-bottom:7px;text-transform:uppercase;letter-spacing:.5px">'+x.l+'</div><div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span class="pred-stat-icon" style="font-size:20px">'+x.i+'</span><div class="mono pred-value" style="font-size:24px;font-weight:700;color:'+x.c+'">'+x.v+'</div></div><div style="font-size:10px;color:var(--t3)">'+x.tr+'</div><div class="pred-detail" style="font-size:10px;color:var(--t2);padding-top:6px;border-top:1px solid var(--bd)">'+x.d+'</div></div>'}).join('')+'</div>'+
'<div class="card chart-card" style="margin-bottom:18px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px"><h3 style="font-size:15px;font-weight:600">'+p.charAt(0).toUpperCase()+p.slice(1)+' Forecast</h3><div style="display:flex;gap:12px">'+[{l:'Actual',c:'#5b8cff'},{l:'Predicted',c:'#b07cff'},{l:'Budget',c:'#5a5a7a'}].map(function(l){return'<div style="display:flex;align-items:center;gap:4px;font-size:10px;color:var(--t3)"><div style="width:8px;height:8px;border-radius:3px;background:'+l.c+'"></div>'+l.l+'</div>'}).join('')+'</div></div><canvas id="chart-pred" style="width:100%;height:280px"></canvas></div>'+
'<div class="grid g3">'+[{i:'ğŸ“‰',t:'Spending Trajectory',v:'-8.2%',c:'var(--green)',d:'Trending down vs 3-month avg',det:'Your daily average dropped from $168 to $142'},{i:'ğŸ¯',t:'Goal Forecast',v:'Apr 2026',c:'var(--blue)',d:'Emergency fund target date',det:'$4,200 remaining at current $420/mo rate'},{i:'ğŸ’°',t:'Projected Savings',v:'$18,240',c:'var(--amber)',d:'End-of-year estimate',det:'Based on current savings rate of 32%'}].map(function(c){return'<div class="card pred-card" style="text-align:center"><div class="pred-icon" style="font-size:30px;margin-bottom:8px">'+c.i+'</div><div style="font-size:13px;font-weight:600;margin-bottom:3px">'+c.t+'</div><div class="mono pred-value" style="font-size:24px;font-weight:700;color:'+c.c+';margin-bottom:3px">'+c.v+'</div><div style="font-size:11px;color:var(--t3)">'+c.d+'</div><div class="pred-detail" style="font-size:11px;color:var(--t2);padding-top:6px;border-top:1px solid var(--bd)">'+c.det+'</div></div>'}).join('')+'</div></div>';}

// ==== CHAT ====
function renderChat(){var hasKey=!!apiKey;if(!state.chatOpen)return'<button class="chat-fab" onclick="set({chatOpen:true})">ğŸ¤–</button>';return'<button class="chat-fab" onclick="set({chatOpen:false})" style="font-size:18px">âœ•</button><div class="chat-window"><div class="chat-header"><div style="display:flex;align-items:center;gap:8"><div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#5b8cff,#b07cff);display:flex;align-items:center;justify-content:center;font-size:16px">ğŸ¤–</div><div><div style="font-size:13px;font-weight:600">VisionFi AI</div><div style="font-size:10px;color:'+(hasKey?'var(--green)':'var(--amber)')+'">'+(hasKey?'â— Connected':'â— Needs Key')+'</div></div></div><div style="display:flex;gap:4px"><button onclick="state.showApiSetup=!state.showApiSetup;render()" style="background:none;border:none;color:var(--t2);cursor:pointer;font-size:14px">âš™ï¸</button><button onclick="set({chatOpen:false})" style="background:none;border:none;color:var(--t3);cursor:pointer;font-size:16px">âœ•</button></div></div><div class="chat-body">'+(state.showApiSetup?'<div style="padding:12px;background:var(--bg3);border-radius:10px;border:1px solid var(--bd);margin-bottom:8px"><div style="font-size:12px;font-weight:600;margin-bottom:4px">ğŸ”‘ Claude API Key</div><div style="font-size:10px;color:var(--t3);margin-bottom:6px">Get from <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:var(--blue)">console.anthropic.com</a></div><input id="api-key-input" class="input" type="password" placeholder="sk-ant-api03-..." value="'+(apiKey||'')+'" style="font-size:12px;margin-bottom:6px"/><button class="btn btn-p btn-sm" style="width:100%" onclick="saveApiKey()">Save</button></div>':'')+state.chatMessages.map(function(m){return m.role==='user'?'<div class="msg msg-user">'+m.text+'</div>':m.role==='error'?'<div class="msg msg-err">âš ï¸ '+m.text+'</div>':'<div class="msg msg-ai">'+m.text+'</div>'}).join('')+(state.chatSending?'<div class="typing-indicator"><span></span><span></span><span></span></div>':'')+'</div><div class="chat-input-area"><input id="chat-input" placeholder="Ask about budget, credit, loans..." onkeydown="if(event.key===\'Enter\')sendChat()"'+(state.chatSending?' disabled':'')+'/><button onclick="sendChat()"'+(state.chatSending?' disabled':'')+'>Send</button></div></div>';}
function saveApiKey(){var i=document.getElementById('api-key-input');if(i){apiKey=i.value.trim();localStorage.setItem('visionfi_api_key',apiKey);state.showApiSetup=false;state.chatMessages.push({role:'ai',text:'âœ… Connected! Ask me anything.'});render()}}
async function sendChat(){var i=document.getElementById('chat-input');if(!i||state.chatSending)return;var msg=i.value.trim();if(!msg)return;i.value='';state.chatMessages.push({role:'user',text:msg});state.chatSending=true;render();try{var d=state.dashData;var ctx=d?'User:'+d.user.name+',income:$'+d.user.income+',spent:$'+d.stats.totalSpent+',savings:'+d.stats.savingsRate+'%,subs:$'+d.stats.subTotal+'/mo,loans:$'+d.stats.totalLoanBalance+',EMI:$'+d.stats.totalEMI+',credit score:'+(d.creditReport?d.creditReport.credit_score:'N/A')+',cards:'+d.stats.cardCount:'No data';var data=await api('POST','/api/chat',{message:msg,apiKey:apiKey,context:ctx});state.chatMessages.push({role:'ai',text:data.reply})}catch(e){state.chatMessages.push({role:'error',text:e.message})}state.chatSending=false;render();var b=document.querySelector('.chat-body');if(b)b.scrollTop=b.scrollHeight}

// ==== MODAL ====
function renderModal(){if(!state.showAddTx)return'';return'<div class="modal-overlay" onclick="if(event.target===this)set({showAddTx:false})"><div class="modal"><h2 style="font-size:18px;font-weight:700;margin-bottom:16px">Add Transaction</h2><form id="tx-form" style="display:flex;flex-direction:column;gap:12px"><div><label class="label">Description</label><input class="input" id="tx-name" required/></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:9px"><div><label class="label">Amount</label><input class="input" id="tx-amount" type="number" step="0.01" required/></div><div><label class="label">Category</label><select class="input" id="tx-cat">'+['Food & Dining','Transport','Entertainment','Shopping','Subscriptions','Healthcare','Utilities','Housing','Income'].map(function(c){return'<option>'+c+'</option>'}).join('')+'</select></div></div><div><label class="label">Date</label><input class="input" id="tx-date" type="date" value="2026-02-05"/></div><div style="display:flex;gap:8px"><button type="submit" class="btn btn-p" style="flex:1">Add</button><button type="button" class="btn btn-g" style="flex:1" onclick="set({showAddTx:false})">Cancel</button></div></form></div></div>';}

// ==== MAIN RENDER ====
function render(){var root=document.getElementById('root');var html='';if(state.page==='landing')html=renderLanding()+renderChat();else if(state.page==='auth')html=renderAuth();else if(state.page==='app'){html=renderSidebar()+'<main class="main-content" style="margin-left:240px;padding:24px 28px;max-width:1060px">'+(state.tab==='dashboard'?renderDashboard():'')+(state.tab==='credit'?renderCredit():'')+(state.tab==='investments'?renderInvestments():'')+(state.tab==='insights'?renderInsights():'')+(state.tab==='predictions'?renderPredictions():'')+'</main>'+renderChat()+renderModal();}
root.innerHTML=html;
requestAnimationFrame(function(){
  var af=document.getElementById('auth-form');if(af){af.onsubmit=async function(e){e.preventDefault();var err=document.getElementById('auth-error');try{var data;if(state.authMode==='register'){data=await api('POST','/api/register',{name:document.getElementById('auth-name').value,email:document.getElementById('auth-email').value,password:document.getElementById('auth-pass').value,income:parseInt((document.getElementById('auth-income')||{}).value)||5000,goal:((document.getElementById('auth-goal')||{}).value)||'General'})}else{data=await api('POST','/api/login',{email:document.getElementById('auth-email').value,password:document.getElementById('auth-pass').value})}state.currentUser=data.user;state.page='app';await loadUsers();await loadDashboard(data.user.id);showToast('Welcome, '+data.user.name+'!','success')}catch(e){if(err){err.textContent=e.message;err.classList.add('show')}}}}
  var tf=document.getElementById('tx-form');if(tf){tf.onsubmit=async function(e){e.preventDefault();try{var amt=parseFloat(document.getElementById('tx-amount').value),cat=document.getElementById('tx-cat').value;await api('POST','/api/transactions',{user_id:state.currentUser.id,name:document.getElementById('tx-name').value,amount:amt,category:cat,icon:cat==='Income'?'ğŸ’°':'ğŸ’³',date:document.getElementById('tx-date').value,type:amt>0?'income':'expense'});state.showAddTx=false;await loadDashboard(state.currentUser.id);showToast('Added!','success')}catch(e){showToast(e.message,'error')}}}
  var cf=document.getElementById('chart-cf');if(cf)drawChart(cf,genMonthly(),{series:[{key:'income',color:'#5b8cff',fill:true,width:2},{key:'spending',color:'#ff6b6b',fill:true,width:2}],fmtY:function(v){return'$'+(v/1000).toFixed(0)+'k'}});
  var cp=document.getElementById('chart-pred');if(cp){var p=state.predPeriod,data;if(p==='daily')data=genDaily();else if(p==='weekly')data=genWeekly();else data=genMonthly().map(function(d){return{label:d.label,actual:d.spending,predicted:d.spending*(.85+Math.random()*.3),budget:d.income*.6}});if(p==='weekly')drawChart(cp,data,{series:[{key:'actual',color:'#5b8cff',type:'bar'},{key:'predicted',color:'#b07cff',type:'bar',opacity:.5},{key:'budget',color:'#5a5a7a',dash:[6,3],width:1.5}]});else drawChart(cp,data,{series:[{key:'actual',color:'#5b8cff',fill:true,width:2},{key:'predicted',color:'#b07cff',dash:[6,3],width:2},{key:'budget',color:'#5a5a7a',dash:[3,3],width:1.5}]})}
  var cc=document.getElementById('chart-credit');if(cc){var cr=state.dashData&&state.dashData.creditReport;if(cr){var sc=cr.credit_score;var cdata=['Aug','Sep','Oct','Nov','Dec','Jan','Feb'].map(function(m,i){return{label:m,score:sc-42+i*7}});drawChart(cc,cdata,{series:[{key:'score',color:scoreColor(sc),fill:true,width:3}],fmtY:function(v){return Math.round(v)}})}}
  var cb=document.querySelector('.chat-body');if(cb)cb.scrollTop=cb.scrollHeight;
});}

window.set=set;
window.switchUser=function(id){loadDashboard(id);loadUsers()};
window.sendChat=sendChat;
window.saveApiKey=saveApiKey;
render();
window.addEventListener('resize',function(){render()});
